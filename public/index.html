<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leaderboard - PoE</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: #1a1a1a;
            color: white;
        }
		table {
			font-size: 10px;
			width: 50%;
			margin: 10px auto;
			border-collapse: collapse;
		}
		th, td {
			padding: 5px;
			border: 1px solid #444;
		}
		th {
			background-color: #222;
		}

		/* Kolory dla klas */
		.Marauder, .Juggernaut, .Berserker, .Chieftain { color: #ff5733; }
		.Witch, .Necromancer, .Elementalist, .Occultist { color: #8e44ad; }
		.Templar, .Inquisitor, .Hierophant, .Guardian { color: #3498db; }
		.Shadow, .Assassin, .Saboteur, .Trickster { color: #2ecc71; }
		.Duelist, .Slayer, .Gladiator, .Champion { color: #f39c12; }
		.Ranger, .Deadeye, .Raider, .Pathfinder, .Warden { color: #1abc9c; }
		.Scion, .Ascendant { color: #ffffff; }  
		.dead { color: gray !important; }

        /* Tryb jasny */
        .light-mode {
            background-color: white;
            color: black;
        }
        .light-mode table {
            border-color: black;
        }
        .light-mode th {
            background-color: #f4f4f4;
        }
    </style>
</head>
<body>
    <h1>Leaderboard - Cmentarzysko x Kasztanowa</h1>

    <button id="toggleDarkMode">‚òÄÔ∏è Tryb jasny</button>
    <input type="text" id="searchInput" placeholder="Wyszukaj postaƒá lub konto..." />
    <button id="toggleDeadOnly">üíÄ Poka≈º tylko martwych</button>

    <p id="stats"></p> <!-- Informacje o liczbie postaci i martwych -->

    <table>
        <thead>
            <tr>
                <th>Pozycja</th>
                <th>Konto</th>
                <th>Postaƒá</th>
                <th>Poziom</th>
                <th>Klasa</th>
                <th>Stan</th>
            </tr>
        </thead>
        <tbody id="leaderboard"></tbody>
    </table>
    
    <button id="prevPage">Poprzednia</button>
    <button id="nextPage">Nastƒôpna</button>

    <div id="additionalStats">
        <h3>Statystyki:</h3>
        <p id="averageTop50"></p>
        <p id="averageTop100"></p>
        <p id="aliveAboveLevel10"></p>
    </div>

    <script>
        let offset = 0;
        const limit = 50;
        const totalResults = 5000;  // Ogranicz liczbƒô wynik√≥w do pobrania
        let darkMode = true;
        let showOnlyDead = false;  
        let allEntries = [];  // Zmienna na wszystkie dane leaderboarda

        document.body.classList.toggle("light-mode", !darkMode);

        document.getElementById("toggleDarkMode").addEventListener("click", () => {
            darkMode = !darkMode;
            document.body.classList.toggle("light-mode", !darkMode);
            document.getElementById("toggleDarkMode").innerText = darkMode ? "‚òÄÔ∏è Tryb jasny" : "üåô Tryb ciemny";
        });

        document.getElementById("toggleDeadOnly").addEventListener("click", () => {
            showOnlyDead = !showOnlyDead;
            document.getElementById("toggleDeadOnly").innerText = showOnlyDead ? "üèÜ Poka≈º wszystkich" : "üíÄ Poka≈º tylko martwych";
            fetchLeaderboard();
        });

        // Pobieramy wszystkie dane leaderboarda na raz
        async function fetchAllEntries() {
            try {
                const response = await fetch(`/leaderboard?limit=${totalResults}`);
                const data = await response.json();
                allEntries = data.entries;  // Zapisujemy wszystkie dane
                fetchLeaderboard();  // Wywo≈Çujemy funkcjƒô do wy≈õwietlenia danych
                calculateAdditionalStats();  // Obliczamy dodatkowe statystyki
            } catch (error) {
                console.error("B≈ÇƒÖd ≈Çadowania leaderboarda:", error);
            }
        }

        function filterEntries() {
            const search = document.getElementById("searchInput").value.toLowerCase();
            return allEntries.filter(entry => {
                const matchesSearch = entry.characterName.toLowerCase().includes(search) || entry.accountName.toLowerCase().includes(search);
                const matchesDeadOnly = !showOnlyDead || entry.dead;
                return matchesSearch && matchesDeadOnly;
            });
        }

        function renderLeaderboard(entries) {
            const tableBody = document.getElementById("leaderboard");
            tableBody.innerHTML = '';
            
            entries.slice(offset, offset + limit).forEach(entry => {
                const isDead = entry.dead ? 'üíÄ RIP' : '';
                const className = entry.class ? entry.class.replace(/\s+/g, '') : 'Unknown';
                
                const row = `<tr class="${className} ${entry.dead ? 'dead' : ''}">
                    <td>${entry.rank}</td>
                    <td>${entry.accountName}</td>
                    <td>${entry.characterName}</td>
                    <td>${entry.level}</td>
                    <td>${entry.class}</td>
                    <td>${isDead}</td>
                </tr>`;
                tableBody.innerHTML += row;
            });

            // Wy≈õwietlamy statystyki
            const totalCharacters = entries.length;
            const totalDead = entries.filter(entry => entry.dead).length;
            document.getElementById("stats").innerText = `Liczba postaci: ${totalCharacters} | Liczba martwych: ${totalDead}`;
        }

        function calculateAdditionalStats() {
            const top50 = allEntries.slice(0, 50);
            const top100 = allEntries.slice(0, 100);

            // ≈öredni poziom top 50
            const averageTop50 = top50.reduce((acc, entry) => acc + entry.level, 0) / top50.length;
            document.getElementById("averageTop50").innerText = `≈öredni poziom top 50: ${averageTop50.toFixed(2)}`;

            // ≈öredni poziom top 100
            const averageTop100 = top100.reduce((acc, entry) => acc + entry.level, 0) / top100.length;
            document.getElementById("averageTop100").innerText = `≈öredni poziom top 100: ${averageTop100.toFixed(2)}`;

            // Ilo≈õƒá ≈ºywych postaci > 10 lvl
            const aliveAboveLevel10 = allEntries.filter(entry => !entry.dead && entry.level > 10).length;
            document.getElementById("aliveAboveLevel10").innerText = `Ilo≈õƒá ≈ºywych postaci >10 lvl: ${aliveAboveLevel10}`;
        }

        function fetchLeaderboard() {
            const filteredEntries = filterEntries();
            renderLeaderboard(filteredEntries);
        }

        document.getElementById("prevPage").addEventListener("click", () => {
            if (offset >= limit) {
                offset -= limit;
                fetchLeaderboard();
            }
        });

        document.getElementById("nextPage").addEventListener("click", () => {
            offset += limit;
            fetchLeaderboard();
        });

        document.getElementById("searchInput").addEventListener("input", fetchLeaderboard);
    </script>
</body>
</html>
